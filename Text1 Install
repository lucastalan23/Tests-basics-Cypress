## PrefÃ¡cio

Num blog de um entusiasta de testes eu li, "Better world by better software" ğŸ¤”<b>
Essa frase ficou na minha cabeÃ§a.

O mundo que vivemos pede cada vez mais agilidade, muitas empresas - na maior parte startups - tem a acelaraÃ§Ã£o da informaÃ§Ã£o como modelo de negÃ³cio. Seja com de processos bancÃ¡rios nas fintechs, centralizaÃ§Ã£o e extraÃ§Ã£o de dados nas grandes plataformas ou anÃ¡lises de dados nos mais diversos segmentos.

Garantia de qualidade Ã© uma das partes mais importantes na vida de um software, e hoje com com os processos agÃ©is de desenvolvimento testes manuais sÃ£o muito custosos e nem sempre assertivos.

 Desenvolver testes automatizados Ã© hoje quesito de sobrevivencia num mercado cada vez mais complexo e exigente, alÃ©m de serem um diferencial para profissionais na Ã¡rea.

Nos ultimos 5 meses, eu desenvolvi testes para 35% das features da plataforma digital do Cubo, onde trabalho como fullstack, esse post tem como base minhas experiencias e problemas nessas implementaÃ§Ãµes.

## IntroduÃ§Ã£o

Testes end-to-end (e2e) sÃ£o testes nos quais nos realizamos fluxos completos na visÃ£o do usuÃ¡rio final do produto.

AtravÃ©s de cÃ³digo, botÅes serÃ£o clicados, formulÃ¡rios preenchidos e demais interaÃ§Åes com sua plataforma, validando se cada passo de um fluxo estÃ¡ devidamente funcionando. Se vocÃª nunca escreveu testes, um passo importante Ã© pensar como o usuÃ¡rio.

Ao se colocar como usuÃ¡rio final, definindo as aÃ§Ãµes que o mesmo vai exercer naquela tela ou fluxo, vocÃª ganha atÃ© mais visibilidade sobre o que o seu produto realmente Ã©. Sua finalidade.

## O que Ã© o Cypress

O Cypress Ã© uma ferramenta incrivel, um framework inteiro escrito Javascript que roda testes dentro do navegador. NÃ£o necessitando da instalaÃ§Ã£o de drivers como o do Selenium. TrÃ¡s libs como o JQuery e Moment para dentro da suite de testes caso queira utilizar.

Fornece uma sÃ©rie de ferramentas bem eficientes para a elaboraÃ§Ã£o e debug dos testes. 
ManipulaÃ§Ã£o facilitada do DOM, permitir salvar videos dos testes realizados, suporte a Typescript e algumas outras coisas fazem dele um framework com baixa curva de aprendizado.

## Pensando como um teste ğŸ§ 

Digamos que vocÃª tenha uma plataforma de vagas, onde candidatos se apliquem em oportunidades jÃ¡ prÃ© cadastradas, o fluxo para um candidato seria

1. Cadastrar candidato
2. Pesquisar vagas
3. Se candidatar em uma vaga

O usuÃ¡rio precisa se cadastrar, pesquisar por vagas e se candidatar a uma delas. Essas sÃ£o as aÃ§Ãµes necessÃ¡rias para efetuar o fluxo de candidatura.

## Manipulando elementos do DOM

O JS roda dentro do navegador, Ã© a linguagem da web, podendo estar no core da aplicaÃ§Ã£o como Angular e React ou em interaÃ§Ãµes menores numa plataforma PHP.

Para escrevermos um teste simples Ã© imprescindÃ­vel termos a noÃ§Ã£o bÃ¡sica de **seletores, aÃ§Ãµes e valores**.

As aÃ§Ãµes do javascript sobre os elementos na tela Ã© um tema longo. de maneira simplista passarei o bÃ¡sico necessÃ¡rio para preenchermos alguns campos e clicar em botÃµes.

EntÃ£o blz. Como o javascript seleciona, muda e verifica valores de elementos HTML ? ğŸ¤”

### Seletores

Entre outras paradas, elementos HTML possuem nomes e atributos. AtravÃ©s dessa identificaÃ§Ã£o, conseguimos capturar e manipular elementos com javascript.

Temos o elemento h3

```html
<h3 class="title" id="title__koe" >KoÃ©</h3>
```

Que pode ser selecionado de diversas formas, pelo nome, pela classe, ou por qualquer outro atributo.

```javascript
document.getElementByClassName('title')
// Ou
document.getElementById('title')
// E muitas outras formas

/* Uma vez tendo o elemento,
   podemos manipula-lo de diversas formas
   SÃ£o varios os metodos disponiveis
   nesse objeto javascript */
const domElement = document.getElementById('title');
```

<small>[Para aprender mais sobre seletores](https://www.w3schools.com/w3js/w3js_selectors.asp) ğŸ“š</small>

### AÃ§Ãµes e valores

Podemos fazer diversas coisas apÃ³s ter o elemento em uma variÃ¡vel, como colocar ou remover atributos, para incluir uma classe nova e formando uma animaÃ§Ã£o por exemplo. Ou verificar o valor daquele campo, para pegar o nome do usuÃ¡rio caso seja um campo de texto e o mesmo tenha preenchido.

SÃ£o inumeras as possibilidades, para testes, o que mais fazemos Ã© ler valores de campos e escrever valores em campos.

Num site de vagas, como exemplifiquei anterioremente, para cadastrar um candidato devemos preencher um formulÃ¡rio com inputs variados, select boxes e etc. Coisas que apenas com javascript seria doloroso, mas o Cypress ajuda.

```javascript
// Pegando texto de um elemento com javascript puro
document.getElementById('name').innerHTML;

// Pegando texto de um elemento com com Cypress
cy.get('#name').value()
```

<p align="middle" style="padding: 20px 0">
<img width="40%" src="https://ih1.redbubble.net/image.666211991.1707/flat,550x550,075,f.u2.jpg"></img><br>
<small>Partiu codar um teste entÃ£o ğŸ’»</small>
</p>

## Testando com Cypress

No exemplo prÃ¡tico que faremos, Ã© o teste de cadastro e login, com preenchimento de dois campos em cada tela.

Para o exemplo, vamos utilizar um site feito para praticar testes de cadastro e login simples.
O nosso roteiro de teste Ã©:

1. Se cadastrar
2. Realizar login

### Criando um projeto Node

De qualquer plataforma, tendo o [Node](https://nodejs.org/) e o [NPM](https://www.npmjs.com/) devidamente instalados, basta usarmos o gerenciador de pacotes para iniciar um projeto e Instalar o Cypress. Rodando o comando de instalaÃ§Ã£o tranquilÃ£o do seu bash ğŸ¤™.

Primeiro precisamos criar um projeto Node, para entÃ£o instalar o Cypress e adicionar um npm script no package.json, para o Cypress rodar dentro do projeto.

<small>ğŸ‘¨â€ğŸ’»Para rodar no seu bash</small>

```shell
mkdir testing-cypress
cd testing-cypress
npm init
```

Conclua a wizard do NPM e teremos uma nova pasta, com um projeto pronto para ser iniciado.

### Instalando o Cypress

Na pasta raiz do seu projeto instale o Cypress com o NPM

``` shell 
npm install cypress@3.8.2 --save-dev
```

ApÃ³s o NPM concluir a instalaÃ§Ã£o, teremos uma nova pasta, com um projeto pronto para ser iniciado.

VÃ¡ no arquivo *package.json* que foi gerado pelo ```npm init``` e insira um novo registro em "scripts", deixando como no json abaixo.

```JSON
{
  "name": "foo",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test:e2e": "cypress open", // essa linha o/
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "cypress": "^3.8.2"
  }
}
```

Feito isso, nosso NPM script estÃ¡ criado e ja podemos abrir o Cypress com sua interface grafica. Abrindo pela primeira vez, ele criarÃ¡ uma estrutura de pastas padrÃ£o. Sinta-se livre para dar uma explorada.

Abra o Cypress e gere as pastas rodando o comando na pasta raÃ­z do projeto.

<small>ğŸ‘¨â€ğŸ’»Para rodar no seu bash</small>
```shell
npm run test:e2e
```

Dessa forma o Cypress vai se configurar automaticamente e irÃ¡ gerar a seguinte estrutura de pastas

```shell
cypress
â”œâ”€â”€ fixtures # ğŸ‘ˆNessa pasta ficam arquivos, como mocks ou imagens
â”‚   â””â”€â”€ example.json
â”œâ”€â”€ integration # ğŸ‘ˆAqui Ã© onde nossos testes habitam
â”‚   â””â”€â”€ examples # ğŸ‘ˆExemplos excelentes para serem estudados
â”‚       â”œâ”€â”€ actions.spec.js
â”‚       â”œâ”€â”€ aliasing.spec.js
â”‚       â”œâ”€â”€ assertions.spec.js
â”‚       â”œâ”€â”€ connectors.spec.js
â”‚       â”œâ”€â”€ cookies.spec.js
â”‚       â”œâ”€â”€ cypress_api.spec.js
â”‚       â”œâ”€â”€ files.spec.js
â”‚       â”œâ”€â”€ local_storage.spec.js
â”‚       â”œâ”€â”€ location.spec.js
â”‚       â”œâ”€â”€ misc.spec.js
â”‚       â”œâ”€â”€ navigation.spec.js
â”‚       â”œâ”€â”€ network_requests.spec.js
â”‚       â”œâ”€â”€ querying.spec.js
â”‚       â”œâ”€â”€ spies_stubs_clocks.spec.js
â”‚       â”œâ”€â”€ traversal.spec.js
â”‚       â”œâ”€â”€ utilities.spec.js
â”‚       â”œâ”€â”€ viewport.spec.js
â”‚       â”œâ”€â”€ waiting.spec.js
â”‚       â””â”€â”€ window.spec.js
â”œâ”€â”€ plugins # ğŸ‘ˆPasta onde ficam plugins que podemos criar e/ou utilizar
â”‚   â””â”€â”€ index.js
â””â”€â”€ support # ğŸ‘ˆOnde se cria funÃ§Ãµes globais, reutilizÃ¡veis em todos os testes.
    â”œâ”€â”€ commands.js
    â””â”€â”€ index.js

5 directories, 23 files
```

O comando abrirÃ¡ tambÃ©m a interface grÃ¡fica do Cypress, onde podemos ver os testes criados, e assistir eles serem rodados, inclusive com auto reload.

<p align="middle" style="padding: 20px 0">
<img width="80%" src="https://i.imgur.com/voDvx4s.png"></img><br>
<small>Tela de Welcome do Cypress</small>
</p>

### Criando os testes de cadastro e login

Crie, manualmente ou com o codigo abaixo, um novo arquivo javascript na pasta ```cypress/integrations``` e abra ele num editor de texto. Como Ã© um teste de cadastro, poderemos chamar ele de ```login.spec.js```.

<small>ğŸ‘¨â€ğŸ’»Para rodar no seu bash, na pasta raiz do projeto</small>

```shell
cd cypress/integration/
touch login.spec.js
```

#### Fluxo
<p align="center">
<img width="80%" src="https://media.giphy.com/media/gdfoTj96xjmfky8NPP/giphy.gif">
</p>

#### CÃ³digo

**login.spec.js**

```javascript
// PÃ¡gina que vamos testar
const url = 'http://thedemosite.co.uk/addauser.php'

// Vamos gerar uma conta com crendenciais randomicas
const username = String(Math.ceil(Math.random()*1000000));
const password = String(Math.ceil(Math.random()*1000000));

context('Cadastro de usuÃ¡rio', () => {
  before(() => {
    cy.visit(url)
  });

  it('Realizar cadastro de usuÃ¡rio', () => {

    // Preenchimento dos campos
    cy.get('input[name="username"').type(username);
    cy.get('input[name="password"').type(password);

    // Clique no botÃ£o de registro
    cy.get('input[name="FormsButton2"').click();

    /*  Para saber se a conta efetivamente foi criada
        precisamos ver qual mensagem de sucesso o site retorna
        no caso desse site, dois elementos sao preenchidos
        com os dados da conta criada, vamos validar se os valores
        desses elementos, correspondem as nossas variaveis de
        nome e senha */
    cy.get('blockquote').eq(3).should('contain', username);
    cy.get('blockquote').eq(3).should('contain', password);  
  });

  it('Realizar login com usuÃ¡rio criado', () => {
    cy.get('a[href="login.php"').first().click();

    // Preenchimento dos campos
    cy.get('input[name="username"').type(username);
    cy.get('input[name="password"').type(password);

    // Clique no botÃ£o de login
    cy.get('input[name="FormsButton2"').click();

    // Verificando se o login foi feito com sucesso
    cy.get('blockquote').first().should('contain.text', '**Successful Login**');
  });
});
```

Agora inicie o Cypress no projeto com o ```npm run test:e2e``` e clique no seu teste ```login.spec.js```.
<p align="center">
<img width="80%" src="https://media.giphy.com/media/lqXlqoZ8fIJQIphhuI/giphy.gif">
</p>

## ConclusÃ£o

Como diz o prÃ³prio site do Cypress, a web evoluiu, e finalmente os testes tambÃ©m. Espero que eu tenha passado como Ã© facil realizar testes, prÃ¡tica ainda obscura para muitos devs.

Pretendo fazer posts no meu blog mais profundos, desde upload de arquivos atÃ© problemas mais avanÃ§ados de assincronia e problemas comuns.

O artigo ficou longo, mas eu opto dessa forma para que qualquer um consiga consumir e aprender o artigo, e quem jÃ¡ sabe JS, pular para o que interessa.

Obrigado ğŸ˜.